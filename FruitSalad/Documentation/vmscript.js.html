<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>DocStrap Source: vmscript.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">DocStrap</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="NangiTrack.html">NangiTrack</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="ChildProcessHost.html">Helper/ChildProcessHost</a>
						</li>
						
						<li>
							<a href="module-vmscript.html">vmscript</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Book.html">Book</a>
						</li>
						
						<li>
							<a href="Command.html">Command</a>
						</li>
						
						<li>
							<a href="ChildProcessHost-ChildProcessHost.html">Helper/ChildProcessHost~ChildProcessHost</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="tutorial-command_.html">command</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: vmscript.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">var fs = require('fs');
var EventEmitter = require('events').EventEmitter;
EventEmitter = new EventEmitter();
var vm = require('vm');
var path = require('path');

var array = {};
var fileStats = {};
var dependencies = {};

function VMScriptObj(){
	var self = this;

	EventEmitter.on('file added', function(file_path){
		console.log("file added", file_path);
		self.parse(file_path);
	});

	EventEmitter.on('file changed', function(file_path){
		console.log("file changed", file_path);
		self.parse(file_path);
	});

	EventEmitter.on('file removed', function(file_path){
		console.log("file removed", file_path);
	});

	EventEmitter.on('check dependencies', function(){
		for(var dependent in dependencies){
			var d = dependencies[dependent];

			if(d.depends && !d.running && !d.hasError){
				var loaded = 0;
				for(var i=0; i&lt;d.depends.length; i++){
					var dp = d.depends[i];
					if(dependencies[dp] && dependencies[dp].running){
						loaded++;
					}
				}

				if(loaded === d.depends.length){
					if(d.callback){
						try{
							d.callback();
							d.running = true;
							EventEmitter.emit('check dependencies');
						}catch(e){
							console.log(e);
							d.hasError = true;
						}
					}
				}
			}
		}
	});
};

/* Reading the file contents and runs the code in this context. */
VMScriptObj.prototype.parse = function(file_path){
	fs.readFile(file_path, function(err, content){
		if(err){
			console.log(err);
			return;
		}

		var infos = path.parse(file_path);
		var ext = infos.ext.toLowerCase();
		var code = content.toString();

		global.require = require;
		global.file_path = file_path;

		var split_dir = infos.dir.split('\\');
		var file_name = getFilename(infos);

		dependencies[file_name] = {
			running: false,
			file_path: file_path
		};

		switch(ext){
			case '.json':
			try{
				vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + '.' + infos.name + ' = ' + code + ';');
				dependencies[file_name].running = true;
				EventEmitter.emit('check dependencies');
			}catch(e){
				try{
					vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + ' = {};');
					vm.runInThisContext(split_dir[split_dir.length-1].toLowerCase() + '.' + infos.name + ' = ' + code + ';');
					dependencies[file_name].running = true;
					EventEmitter.emit('check dependencies');
				}catch(e){
					console.log(e);
				}
			}
			break;

			case '.js':
			try{
				vm.runInThisContext(code);
				EventEmitter.emit('check dependencies');
			}catch(e){
				console.log(e);
			}
			break;
		}

		delete global.file_path;
	});
};

/* Function to return a file name based on directory and name. */
function getFilename(infos){
	var split_dir = infos.dir.split('\\');
	// TODO: Consider adding a __dirname check if we wont name the file outside project directory.
	return split_dir[split_dir.length-1] + '/' + infos.name + infos.ext.toLowerCase();
}

/* Function used to watch the file or directory for changes. */
VMScriptObj.prototype.watch = function(file_path){
	
	file_path = path.resolve(file_path);
	if(array[file_path]) return;

	var directory = false;
	fs.stat(file_path, function(err, stats){
		if(err){
			console.log(err);
			return;
		}

		if(stats.isDirectory()){
			directory = true;
			array[file_path] = {
				files: []
			};

			fs.readdir(file_path, function(err, files){
				if(err){
					console.log(err);
					return;
				}

				for(var i=0; i&lt;files.length; i++){
					var fp = file_path + '\\' + files[i];
					array[file_path].files.push(fp);
					fileStats[fp] = fs.statSync(fp);
					EventEmitter.emit('file added', fp);
				}
			});
		}else if(stats.isFile()){
			array[file_path] = {
				stats: stats
			};

			EventEmitter.emit('file added', file_path);
		}

		fs.watch(file_path, function(){
			if(directory){
				fs.readdir(file_path, function(err, files){
					if(err){
						console.log(err);
						return;
					}

					files = files.filter(function(file){
						var infos = path.parse(file_path + '\\' + file);
						return infos.ext !== '.tmp' && infos.ext !== '.TMP';
					});

					for(var i=0; i&lt;files.length; i++){
						files[i] = file_path + '\\' + files[i];

						var stat = fs.statSync(files[i]);
						var index = array[file_path].files.indexOf(files[i]);
						if(index > -1){
							var prvStat = fileStats[files[i]];

							if(prvStat.mtime.getTime() !== stat.mtime.getTime()){
								fileStats[files[i]] = stat;
								EventEmitter.emit('file changed', files[i]);
							}
							continue;
						}

						array[file_path].files.push(files[i]);
						EventEmitter.emit('file added', files[i]);
					}

					for(var i=0; i&lt;array[file_path].files.length; i++){
						var f = array[file_path].files[i];
						try{
							fs.statSync(f);
						}catch(err){
							EventEmitter.emit('file removed', err.path);
							array[file_path].files.splice(
								array[file_path].files.indexOf(err.path),
								1
							);
						}
					}
				});
			}else{
				if(array[file_path]){
					fs.stat(file_path, function(err, stat){
						if(err){
							// delete array[file_path];
							// localEmitter.emit('file remove', err.path);
							// console.log('Removed file:', err.path);
							return;
						}

						var prvStat = array[file_path].stats;

						if(prvStat.mtime.getTime() !== stat.mtime.getTime()){
							array[file_path].stats = stat;
							EventEmitter.emit('file changed', file_path);
						}
					});
				}
			}
		});
	});
};

/* Exposed function to global scope for registering dependencies. */
VMScriptObj.prototype.vms = function(name, depends, callback){
	// console.log(this.file_path);
	// console.log(name);
	dependencies[name] = {
		running: false,
		depends: depends,
		callback: callback
	};

	EventEmitter.emit('check dependencies');
};

/**
 * A module that exports methods to watch script files for changes.
 * And to load scripts at runtime.
 * @module vmscript
 */
module.exports = VMScriptObj;</pre>
	</article>
</section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		DocStrap Copyright Â© 2012-2014 The contributors to the JSDoc3 and DocStrap projects.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a>
		on Sun May 17th 2015 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>
